

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Building Model Rules &mdash; bhp_bucket 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="bhp_bucket 1.0 documentation" href="index.html" />
    <link rel="next" title="Signals" href="signals.html" />
    <link rel="prev" title="Overview" href="overview.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="signals.html" title="Signals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">bhp_bucket 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="building-model-rules">
<h1>Building Model Rules<a class="headerlink" href="#building-model-rules" title="Permalink to this headline">¶</a></h1>
<div class="section" id="a-simple-example">
<h2>A Simple Example<a class="headerlink" href="#a-simple-example" title="Permalink to this headline">¶</a></h2>
<p>A simple rule might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">has_cd4</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;has_cd4&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
    <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;hivhistorycd4&#39;</span><span class="p">]</span> <span class="p">,</span>
     <span class="p">)</span>
</pre></div>
</div>
<p>This is a rule that sets the entry status of a a <strong>scheduled</strong> model to either <strong>required</strong> or <strong>not required</strong>.
The <strong>scheduled</strong> model is the <tt class="xref py py-attr docutils literal"><span class="pre">target_model</span></tt> <tt class="xref py py-class docutils literal"><span class="pre">HiVHistoryCd4</span></tt>. The <tt class="xref py py-attr docutils literal"><span class="pre">logic</span></tt> attribute is a tuple
of (<strong>predicate</strong>, <strong>consequent</strong>, <strong>alternative</strong>) which will resolve into:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">hiv_history_cd4</span><span class="o">.</span><span class="n">has_cd4</span><span class="o">==</span><span class="s">&#39;yes&#39;</span><span class="p">:</span>
    <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;not_required&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="another-example">
<h2>Another Example<a class="headerlink" href="#another-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arv</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="p">(((</span><span class="s">&#39;on_cont_arv&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),(</span><span class="s">&#39;init_arv&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">)),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
    <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;hivhistoryarv&#39;</span><span class="p">],</span>
     <span class="p">)</span>
</pre></div>
</div>
<p>The logic attribute is still a tuple of (<strong>predicate</strong>, <strong>consequent</strong>, <strong>alternative</strong>) but the <strong>predicate</strong> is
now a tuple of tuples where the second tuple has an extra element <strong>or</strong>.</p>
<p>The resolved code would be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">hiv_history_cd4</span><span class="o">.</span><span class="n">has_cd4</span><span class="o">==</span><span class="s">&#39;yes&#39;</span> <span class="ow">or</span> <span class="n">hiv_history_cd4</span><span class="o">.</span><span class="n">init_arv</span><span class="o">==</span><span class="s">&#39;yes&#39;</span><span class="p">:</span>
    <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;not_required&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="a-slightly-complicate-example">
<h2>A Slightly Complicate Example<a class="headerlink" href="#a-slightly-complicate-example" title="Permalink to this headline">¶</a></h2>
<p>It may be that the field attribute in <strong>predicate</strong> of the <tt class="xref py py-attr docutils literal"><span class="pre">logic</span></tt> tuple does not come from the <tt class="xref py py-attr docutils literal"><span class="pre">target_model</span></tt>
and/or the rule is to change the entry status of more than one target model. In the examples above, the target model and the
model used in the predicate were the same. The model used in the <strong>predicate</strong> is the <strong>reference model</strong> and in most cases it is
the same model as the target model so you do not need to explicitly set the <tt class="xref py py-attr docutils literal"><span class="pre">reference_model</span></tt> attribute. But when it
is not the same or the target model is more than one, you need to set <tt class="xref py py-attr docutils literal"><span class="pre">reference_model</span></tt>.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">reference_model</span></tt> is a tuple of (app_label, model_name). The reference model must have a foreign key to either the
<strong>visit model</strong> or <strong>registered_subject</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">is_hiv_pos</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
    <span class="n">reference_model</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;maikalelo_maternal&#39;</span><span class="p">,</span><span class="s">&#39;maternalenrollment&#39;</span><span class="p">,),</span>
    <span class="n">logic</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;is_hiv_pos&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
    <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;demographichiv&#39;</span><span class="p">,</span><span class="s">&#39;deliveryhiv&#39;</span><span class="p">,</span><span class="s">&#39;hivhistory&#39;</span><span class="p">,</span>
                    <span class="s">&#39;hivhistorycd4&#39;</span><span class="p">,</span> <span class="s">&#39;hivhistoryvl&#39;</span><span class="p">,</span><span class="s">&#39;hivhistorytest&#39;</span><span class="p">,</span> <span class="s">&#39;hivhistoryarv&#39;</span><span class="p">],</span>
     <span class="p">)</span>
</pre></div>
</div>
<p>...will resolve to something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">target_model</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">maternal_enrollment</span><span class="o">.</span><span class="n">is_hiv_positive</span><span class="o">==</span><span class="s">&#39;yes&#39;</span><span class="p">:</span>
       <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">scheduled_entry_bucket</span><span class="o">.</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
</pre></div>
</div>
<p>Note that the model rules have access to the <strong>visit model</strong> of the current visit.</p>
</div>
<div class="section" id="rules-are-attributes-of-a-modelbucket">
<h2>Rules are attributes of a ModelBucket<a class="headerlink" href="#rules-are-attributes-of-a-modelbucket" title="Permalink to this headline">¶</a></h2>
<p>The rules are added as attributes to a subclass of <tt class="xref py py-class docutils literal"><span class="pre">ModelBucket</span></tt> like this:</p>
<div class="highlight-python"><pre>class HivHistoryBucket(ModelBucket):

    rule = ....

    rule = ....

    class Meta:
        app_label = ....
        visit_model = ....</pre>
</div>
</div>
<div class="section" id="a-modelbucket-is-registered-to-bucket-with-a-model">
<h2>A ModelBucket is Registered to <cite>bucket</cite> with a Model<a class="headerlink" href="#a-modelbucket-is-registered-to-bucket-with-a-model" title="Permalink to this headline">¶</a></h2>
<p>The class is registered with bucket along with a model like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">bucket</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">HivHistory</span><span class="p">,</span> <span class="n">HivHistoryBucket</span><span class="p">)</span>
</pre></div>
</div>
<p>The rules will be evaluated when the model is saved, in this case, <strong>HivHistory</strong>.</p>
</div>
<div class="section" id="modelbuckets-are-declared-in-bucket-py">
<h2>ModelBuckets are declared in <tt class="file docutils literal"><span class="pre">bucket.py</span></tt><a class="headerlink" href="#modelbuckets-are-declared-in-bucket-py" title="Permalink to this headline">¶</a></h2>
<p>ModelBuckets are declared in <tt class="file docutils literal"><span class="pre">bucket.py</span></tt>. Place the file in the root of your app.</p>
</div>
<div class="section" id="by-default-rules-evaluate-when-the-model-is-saved">
<h2>By Default, Rules Evaluate When the Model is Saved<a class="headerlink" href="#by-default-rules-evaluate-when-the-model-is-saved" title="Permalink to this headline">¶</a></h2>
<p>The rules in a class evaluate when the model the class was registered with is saved. But the rules can also be
evaluated programatically.</p>
</div>
<div class="section" id="rules-evaluate-in-order">
<h2>Rules Evaluate in Order<a class="headerlink" href="#rules-evaluate-in-order" title="Permalink to this headline">¶</a></h2>
<p>The order in which the model bucket classes are listed matters and the order of the rules within the model bucket class
matters. If rules refer to the same model, only the result of the last rule will matter. In the example below,
the target_model &#8216;hivhistorycd4&#8217; is referred to in HivHistoryBucket and ObHistoryBucket.
Since ObHistoryBucket rules will run last, the result of the HivHistoryBucket
rule referring to target_model &#8216;hivhistorycd4&#8217; will be overwritten.</p>
<p>To the <tt class="file docutils literal"><span class="pre">bucket.py</span></tt> in the app add something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HivHistoryBucket</span><span class="p">(</span><span class="n">ModelBucket</span><span class="p">):</span>

    <span class="n">has_cd4</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;has_cd4&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;hivhistorycd4&#39;</span><span class="p">]</span> <span class="p">,</span>
         <span class="p">)</span>

    <span class="n">arv</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="p">(((</span><span class="s">&#39;on_cont_arv&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),(</span><span class="s">&#39;init_arv&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">)),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;hivhistoryarv&#39;</span><span class="p">],</span>
         <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s">&#39;maikalelo_maternal&#39;</span>
        <span class="n">visit_model</span> <span class="o">=</span> <span class="s">&#39;maternal_visit&#39;</span><span class="p">,</span>

<span class="n">bucket</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">HivHistory</span><span class="p">,</span> <span class="n">HivHistoryBucket</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ObHistoryBucket</span><span class="p">(</span><span class="n">ModelBucket</span><span class="p">):</span>

    <span class="n">is_hiv_pos</span> <span class="o">=</span> <span class="n">ScheduledModelRule</span><span class="p">(</span>
        <span class="n">reference_model</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;maikalelo_maternal&#39;</span><span class="p">,</span><span class="s">&#39;maternalenrollment&#39;</span><span class="p">,),</span>
        <span class="n">reference_model_filter</span> <span class="o">=</span> <span class="s">&#39;registered_subject&#39;</span><span class="p">,</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;is_hiv_pos&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;yes&#39;</span><span class="p">),</span> <span class="s">&#39;new&#39;</span><span class="p">,</span> <span class="s">&#39;not_required&#39;</span><span class="p">),</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;demographichiv&#39;</span><span class="p">,</span><span class="s">&#39;deliveryhiv&#39;</span><span class="p">,</span><span class="s">&#39;hivhistory&#39;</span><span class="p">,</span>
                        <span class="s">&#39;hivhistorycd4&#39;</span><span class="p">,</span> <span class="s">&#39;hivhistoryvl&#39;</span><span class="p">,</span><span class="s">&#39;hivhistorytest&#39;</span><span class="p">,</span> <span class="s">&#39;hivhistoryarv&#39;</span><span class="p">],</span>
         <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s">&#39;maikalelo_maternal&#39;</span>
        <span class="n">visit_model</span> <span class="o">=</span> <span class="s">&#39;maternal_visit&#39;</span><span class="p">,</span>


<span class="n">bucket</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ObHistory</span><span class="p">,</span> <span class="n">ObHistoryBucket</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Building Model Rules</a><ul>
<li><a class="reference internal" href="#a-simple-example">A Simple Example</a></li>
<li><a class="reference internal" href="#another-example">Another Example</a></li>
<li><a class="reference internal" href="#a-slightly-complicate-example">A Slightly Complicate Example</a></li>
<li><a class="reference internal" href="#rules-are-attributes-of-a-modelbucket">Rules are attributes of a ModelBucket</a></li>
<li><a class="reference internal" href="#a-modelbucket-is-registered-to-bucket-with-a-model">A ModelBucket is Registered to <cite>bucket</cite> with a Model</a></li>
<li><a class="reference internal" href="#modelbuckets-are-declared-in-bucket-py">ModelBuckets are declared in <tt class="file docutils literal"><span class="pre">bucket.py</span></tt></a></li>
<li><a class="reference internal" href="#by-default-rules-evaluate-when-the-model-is-saved">By Default, Rules Evaluate When the Model is Saved</a></li>
<li><a class="reference internal" href="#rules-evaluate-in-order">Rules Evaluate in Order</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="overview.html"
                        title="previous chapter">Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="signals.html"
                        title="next chapter">Signals</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/rules.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="signals.html" title="Signals"
             >next</a> |</li>
        <li class="right" >
          <a href="overview.html" title="Overview"
             >previous</a> |</li>
        <li><a href="index.html">bhp_bucket 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, erik van widenfelt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>