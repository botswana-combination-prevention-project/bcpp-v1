{% load common_tags %}{% load dashboard_tags %}
{% load crypto_tags %}
{% load dispatch_tags %}
{% load admin_urls %}
{% load url from future %}


<table border=1 width=100%>
<thead>
<th>First name</th>
<th>Initials</th>
<th>Sex</th>
<th>Age</th>
<th>Relation</th>   
<th>Participation</th>
<th>Eligibility</th> 
<th>Dashboard</th>
</thead>
<tbody>

{% for household_member in household_members %}
    <tr {% if household_member.first_name == first_name %}style="background:lightyellow;"{% else %}class="{% cycle 'row1' 'row2' %}"{% endif %}>
    
    <td>{{ forloop.counter }}.&nbsp;
    {% if not household_member.member_status == 'CONSENTED' %}
    	{% if household_member.household_structure.household.household_identifier|is_dispatched %}
    		{{ household_member.first_name|encrypted }}
    	{% else %}
        	<A href="{% url household_member_meta|admin_urlname:'change' household_member.pk %}?next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_structure={{household_structure.pk}}">{{ household_member.first_name|encrypted }}</A>
        {% endif %}
    {% else %}            
        {{ household_member.first_name|encrypted }}        
    {% endif %} 
    {% if not household_member.present == 'Yes' and not household_member.present == 'No'%}<span style="color:red;font-size:9px;vertical-align:super">Update!</span>{% endif %}            
    </td>
        
    <td>{{ household_member.initials }}</td>
    <td>{{ household_member.gender }}</td>
    <td>{{ household_member.age_in_years }}</td>
    <td>{{ household_member.relation }}</td>
    {% comment%} particpation {% endcomment %}
    <td>
        {% if household_member.is_eligible and not household_member.is_consented %}
            <form name="participation-{{household_member.pk}}" action="{% url 'participation_url' %}" method="post">
                {% csrf_token %}
                <table>
                    <tr>            
                        {{ household_member.participation_form.as_table }}
                    </tr>
                </table>
            </form>
        {% else %}
            {% if household_member.member_status != 'NOT_REPORTED' %}
                {{ household_member.member_status }}
            {% else %}
                {{ household_member.member_status }} {{household_member.is_consented}}
            {% endif %}            
        {% endif %}
    </td>

    {% comment %}eligibility / enrolment checklist{% endcomment %}
    <td>
    {% if 'CONSENT' not in household_member.member_status %}
     ----
    {% else %}
     {% if not household_member.enrolment_checklist %}
        <A title="Add an enrolment checklist to confirm eligibility before consent" href="{% url enrolment_checklist_meta|admin_urlname:'add' %}?next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_member={{household_member.pk}}">Enrolment Checklist</A>
     {% else %}
        {% if not household_member.consent %}
            <A title="Edit the enrolment checklist if not yet consented" href="{% url enrolment_checklist_meta|admin_urlname:'change' household_member.enrolment_checklist.pk %}?next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_member={{household_member.pk}}">{{ household_member.enrolment_checklist }}</A>{% if not household_member.enrolment_checklist.eligible %}&nbsp;<i>(Not eligible)</i>{%endif%}
        {% else %}
            {{ household_member.enrolment_checklist }}            
        {% endif %}
     {% endif %}
    {% endif %}
    </td>

 
    {% comment%} dashboard {% endcomment %}
    <td>
    {% if household_member.enrolment_checklist %}
        {% if household_member.enrolment_checklist.eligible %}
          {% if household_member.present == 'Yes' or household_member.present == 'No'%}        
            {% if 'CONSENT' in household_member.member_status %}
                {% comment%} show a link to the dashboard of this household is not dispatched and subject is consented {% endcomment %}
            	{% if household_member.household_structure.household.household_identifier|is_dispatched %}
            		dashboard{% if household_member.get_hiv_history%}/{{household_member.get_hiv_history}}{%endif%}
            	{% else %}
             		<A name="consented-{{household_member.pk}}" href="{% url 'subject_dashboard_url' dashboard_type='subject' dashboard_model='household_member' dashboard_id=household_member.pk show='appointments' %}">{{ household_member.registered_subject|subject_identifier:'go to consent on dashboard' }}{% if household_member.get_hiv_history%}/{{household_member.get_hiv_history}}{%endif%}</a>
            	{% endif %}
            {% elif 'CONSENT' not in household_member.member_status and household_member.member_status in household_member_actions %}
               {% if household_member.member_status == 'ABSENT' %}
               Absentee log (attempts to contact)
                    <A name="absent-{{household_member.pk}}" href="{{ household_member.absentee_form_url }}?next=next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_structure={{household_structure.pk}}"><ol>{% for label in household_member.absentee_form_label%}<li>{{ label }}{% endfor %}</ol></A>
               {% elif household_member.member_status == 'REFUSED' %}
                    <A name="refused-{{household_member.pk}}" href="{{ household_member.refused_form_url }}?next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_structure={{household_structure.pk}}&household_member={{household_member.pk}}&registered_subject={{household_member.registered_subject.pk }}">{{ household_member.refused_form_label }}</A>
               {% elif household_member.member_status == 'MOVED' %}
                    <A name="moved-{{household_member.pk}}" href="{{ household_member.moved_form_url }}?next=household_dashboard_url&dashboard_type=household&dashboard_model=household_structure&dashboard_id={{ household_structure.pk }}&household_structure={{household_structure.pk}}">{{ household_member.moved_form_label }}</A>
               {% endif %}
            {% else %}
                    <A href="{% url 'subject_dashboard_url' dashboard_type='subject' dashboard_model='household_member' dashboard_id=household_member.pk show='appointments' %}">{{ household_member.registered_subject|subject_identifier:'go to consent on dashboard' }}</A>
            {% endif %}                
            <br>
          {% else %}
            &nbsp;                        
          {% endif %}
        {% endif %}
    {% endif %}
    </td>
                                                                                                
     
    </tr>
{% endfor %}

</tbody>
</table>    