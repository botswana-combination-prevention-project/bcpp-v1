{% load common_tags %}{% load dashboard_tags %}
{% load crypto_tags %}
{% load dispatch_tags %}
{% load admin_urls %}
{% load url from future %}
<table border=1 width=100%>
<thead>
<th>First name</th>
<th>Initials</th>
<th>Sex</th>
<th>Age</th>
<th>Eligibile<sup>2</sup></th>
<th>Participation</th> 
<th>Dashboard</th>
<th>Relation</th>   
<th>Residency</th>           
<th>Present<sup>1</sup></th>
<th>Lives here?</th>                 
</thead>
<tbody>

{% for household_member in household_members %}
    <tr {% if household_member.first_name == first_name %}style="background:lightyellow;"{% else %}class="{% cycle 'row1' 'row2' %}"{% endif %}>
    
    <td>{{ forloop.counter }}.&nbsp;
    {% if not household_member.member_status == 'CONSENTED' %}
    	{% if household_member.household_structure.household.household_identifier|is_dispatched %}
    		{{ household_member.first_name|encrypted }}
    	{% else %}
        	<A href="{% url household_member_meta|admin_urlname:'change' household_member.pk %}?next=dashboard_url&dashboard_type={{ dashboard_type }}&household_identifier={{ household_structure.household.household_identifier }}&household_structure={{household_structure.pk}}&survey={{household_structure.survey.survey_slug}}">{{ household_member.first_name|encrypted }}</A>
        {% endif %}
    {% else %}            
        {{ household_member.first_name|encrypted }}        
    {% endif %} 
    {% if not household_member.present == 'Yes' and not household_member.present == 'No'%}<span style="color:red;font-size:9px;vertical-align:super">Update!</span>{% endif %}            
    </td>
        
    <td>{{ household_member.initials }}</td>
    <td>{{ household_member.gender }}</td>
    <td>{{ household_member.age_in_years }}</td>
    <td>{{ household_member.is_eligible_label }}&nbsp;{% if not household_member.member_status%}{{ household_member.hiv_status }}{% endif %}</td>                                
    
    {% comment%} particpation {% endcomment %}
    <td>
        <ul>
        <li>member_status={{ household_member.member_status }}
        <li>is_eligible={{ household_member.is_eligible }}
        <li>is_consented={{ household_member.is_consented }}
        <li>present={{household_member.present}}
        <li>is_dispatched={{ household_member.household_structure.household.household_identifier|is_dispatched  }}
        </ul>
    
        {% if household_member.is_eligible and not household_member.is_consented %}
            <form name="participation-{{household_member.pk}}" action="{% url 'participation_url' %}" method="post">
                {% csrf_token %}
                <table>
                    <tr>            
                        {{ household_member.participation_form.as_table }}
                    </tr>
                </table>
            </form>
        {% else %}
            {% if household_member.member_status != 'NOT_REPORTED' %}
                {{ household_member.member_status }}
            {% else %}
                {{ household_member.member_status }} {{household_member.is_consented}}
            {% endif %}            
        {% endif %}
    </td>
 

    {% comment%} dashboard {% endcomment %}
    {% if not household_member.is_eligible %}
        <td></td>
    {% else %}
        {% if household_member.present == 'Yes' or household_member.present == 'No'%}        
            {% if 'CONSENT' in household_member.member_status %}
                {% comment%} show a link to the dashboard of this household is not dispatched and subject is consented {% endcomment %}
            	{% if household_member.household_structure.household.household_identifier|is_dispatched %}
            		<td>subject dashboard/{{household_member.get_hiv_history}}</td>
            	{% else %}
             		<td><A name="consented-{{household_member.pk}}" href="{% url 'subject_dashboard_url' dashboard_type='subject' household_member=household_member.pk survey=household_structure.survey.survey_slug %}">subject dashboard/{{household_member.get_hiv_history}}</a></td>
            	{% endif %}
            
            {% elif 'CONSENT' not in household_member.member_status and household_member.member_status in household_member_actions %}
               <td>
               {% if household_member.member_status == 'ABSENT' %}
               Absentee log (attempts to contact)
                    <A name="absent-{{household_member.pk}}" href="{{ household_member.absentee_form_url }}?next=household_dashboard_url&dashboard_type={{ dashboard_type }}&household_identifier={{ household_structure.household.household_identifier }}&household_structure={{household_structure.pk}}&survey={{household_structure.survey.survey_slug}}"><ol>{% for label in household_member.absentee_form_label%}<li>{{ label }}{% endfor %}</ol></A>
               {% elif household_member.member_status == 'REFUSED' %}
                    <A name="refused-{{household_member.pk}}" href="{{ household_member.refused_form_url }}?household_member={{household_member.pk}}&registered_subject={{ household_member.registered_subject.pk }}&next=household_dashboard_url&dashboard_type={{ dashboard_type }}&household_identifier={{ household_structure.household.household_identifier }}&household_structure={{household_structure.pk}}&survey={{household_structure.survey.survey_slug}}">{{ household_member.refused_form_label }}</A>
               {% elif household_member.member_status == 'MOVED' %}
                    <A name="moved-{{household_member.pk}}" href="{{ household_member.moved_form_url }}?household_member={{household_member.pk}}&registered_subject={{ household_member.registered_subject.pk }}&next=household_dashboard_url&dashboard_type={{ dashboard_type }}&household_identifier={{ household_structure.household.household_identifier }}&household_structure={{household_structure.pk}}&survey={{household_structure.survey.survey_slug}}">{{ household_member.moved_form_label }}</A>
               {% endif %}
               </td>
            {% else %}
                <td>
                    <A href="{% url 'subject_dashboard_url' dashboard_type='subject' household_member=household_member.pk survey=household_structure.survey.survey_slug %}">dashboard</A>
                </td>
            {% endif %}                
        {% else %}
            <td>&nbsp;</td>                        
        {% endif %}
    {% endif %}
    <td>{{ household_member.relation }}</td>
    <td>{{ household_member.resident }}</td>
    <td>{{ household_member.present }}</td>                                                                                        
    <td>{{ household_member.lives_in_household }}</td>
                                                                                                
     
    </tr>
{% endfor %}

</tbody>
</table>    